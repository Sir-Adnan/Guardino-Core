<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø´Ø¯ | Ú¯Ø§Ø±Ø¯ÛŒÙ†Ùˆ Ù¾Ø±Ùˆ</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <style>
        .admin-nav { background: #1e293b; border-bottom: 2px solid #3b82f6; }
        .admin-nav a { color: #f8fafc; }
    </style>
</head>
<body class="dark-mode">

<nav class="navbar admin-nav">
    <a href="index.html" class="nav-brand" style="color: #3b82f6;">ğŸ‘‘ GUARDINO CORE</a>
    <div class="nav-menu">
        <a href="index.html" style="color: #3b82f6;">ğŸŒ Ø´Ø¨Ú©Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ (Nodes)</a>
        <a href="resellers.html">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</a>
        <a href="#" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</a>
    </div>
</nav>

<div class="container" style="padding-top: 30px;">
    
    <div class="section-title">âš¡ Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡</div>
    <div class="card" style="border-left: 4px solid #3b82f6;">
        <form id="addNodeForm">
            <div class="smart-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†)</label>
                    <input type="text" id="nodeName" class="form-control" placeholder="Ù…Ø«Ù„Ø§: Ø³Ø±ÙˆØ± VIP Ø¢Ù„Ù…Ø§Ù† ğŸ‡©ğŸ‡ª" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ù…ÙˆØªÙˆØ± Ù¾Ù†Ù„</label>
                    <select id="panelType" class="form-control">
                        <option value="marzban">Ù…Ø±Ø²Ø¨Ø§Ù† (Marzban)</option>
                        <option value="pasarguard">Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯ (PasarGuard)</option>
                        <option value="wgdashboard">ÙˆØ§ÛŒØ±Ú¯Ø§Ø±Ø¯ (WGDashboard)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¢Ø¯Ø±Ø³ API Ø³Ø±ÙˆØ±</label>
                    <input type="url" id="apiUrl" class="form-control" placeholder="https://1.2.3.4:8000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ (Admin Token)</label>
                    <input type="text" id="apiToken" class="form-control" placeholder="ØªÙˆÚ©Ù† Ø§Ø¯Ù…ÛŒÙ† Ù¾Ù†Ù„ Ù…Ù‚ØµØ¯..." required>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="isVisible" checked>
                    <span style="font-weight: bold;">Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù„ÛŒÙ†Ú© Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ù…Ø³ØªØ± Ù„ÛŒÙ†Ú©)</span>
                </label>
                <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Ø§Ú¯Ø± ØªÛŒÚ© Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø±ÙˆØ­ (Ghost Mode) Ù…ÛŒâ€ŒØ±ÙˆØ¯ Ùˆ Ø¯Ø± Ù„ÛŒÙ†Ú© Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
            </div>

            <button type="submit" class="btn-main" id="submitNodeBtn" style="background: #3b82f6; width: 100%; margin-top: 15px;">â• Ø§ØªØµØ§Ù„ Ø³Ø±ÙˆØ± Ø¨Ù‡ Ù‡Ø³ØªÙ‡ Ú¯Ø§Ø±Ø¯ÛŒÙ†Ùˆ</button>
        </form>
    </div>

    <div class="section-title" style="margin-top: 40px;">ğŸŒ Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ØªØµÙ„</div>
    <div class="card">
        <div id="nodesList" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            <p style="text-align: center; opacity: 0.6;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§...</p>
        </div>
    </div>

</div>

<script src="../assets/js/app.js"></script>
<script>
    const token = localStorage.getItem("guardino_token");
    if (!token) window.location.href = "login.html";

    // 1. ØªØ§Ø¨Ø¹ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆØ±Ù‡Ø§ Ø§Ø² API
    async function fetchNodes() {
        try {
            const res = await fetch("http://localhost:8000/api/v1/nodes/list", {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await res.json();
            const container = document.getElementById("nodesList");
            container.innerHTML = "";

            if (data.nodes && data.nodes.length > 0) {
                data.nodes.forEach(node => {
                    const statusColor = node.status === 'active' ? '#10b981' : '#ef4444';
                    container.innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 900; font-size: 1.1rem; color: var(--text);">${node.display_name}</div>
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Ù†ÙˆØ¹: ${node.panel_type.toUpperCase()} | Ø¢Ø¯Ø±Ø³: <span style="direction: ltr; display: inline-block;">${node.api_url}</span></div>
                            </div>
                            <div style="text-align: left;">
                                <span style="background: ${statusColor}20; color: ${statusColor}; padding: 5px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: bold;">${node.status.toUpperCase()}</span>
                                <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">
                                    ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø¨: ${node.is_visible_in_sub ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ‘» Ù…Ø®ÙÛŒ (Ø­Ø§Ù„Øª Ø±ÙˆØ­)'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = "<p style='text-align:center;'>Ù‡ÛŒÚ† Ø³Ø±ÙˆØ±ÛŒ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.</p>";
            }
        } catch (e) {
            document.getElementById("nodesList").innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.";
        }
    }

    // 2. ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯
    document.getElementById('addNodeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitNodeBtn');
        btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...";
        btn.disabled = true;

        const payload = {
            display_name: document.getElementById('nodeName').value,
            panel_type: document.getElementById('panelType').value,
            api_url: document.getElementById('apiUrl').value,
            api_token: document.getElementById('apiToken').value,
            status: "active",
            is_visible_in_sub: document.getElementById('isVisible').checked
        };

        try {
            const res = await fetch("http://localhost:8000/api/v1/nodes/add", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (res.ok) {
                showToast("âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Ù…ØªØµÙ„ Ø´Ø¯!", "success");
                document.getElementById('addNodeForm').reset();
                fetchNodes(); // Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§
            } else {
                showToast(data.detail || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³Ø±ÙˆØ±", "danger");
            }
        } catch (err) {
            showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡Ø³ØªÙ‡.", "danger");
        } finally {
            btn.innerText = "â• Ø§ØªØµØ§Ù„ Ø³Ø±ÙˆØ± Ø¨Ù‡ Ù‡Ø³ØªÙ‡ Ú¯Ø§Ø±Ø¯ÛŒÙ†Ùˆ";
            btn.disabled = false;
        }
    });

    // Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡
    fetchNodes();

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }
</script>
</body>
</html>
