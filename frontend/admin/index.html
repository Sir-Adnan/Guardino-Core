<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ | Ú¯Ø§Ø±Ø¯ÛŒÙ†Ùˆ Ù¾Ø±Ùˆ</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <style>
        .admin-nav { background: #1e293b; border-bottom: 2px solid #3b82f6; }
        body.dark-mode .admin-nav { background: #0f172a; }
        .admin-nav a { color: #f8fafc; }
    </style>
</head>
<body class="dark-mode">

<nav class="navbar admin-nav">
    <a href="index.html" class="nav-brand" style="color: #3b82f6;">ğŸ‘‘ GUARDINO CORE</a>
    <div class="hamburger" onclick="toggleMenu()">â˜°</div>
    <div class="nav-menu" id="navMenu">
        <a href="index.html" style="color: #3b82f6;">ğŸŒ Ø´Ø¨Ú©Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ (Nodes)</a>
        <a href="resellers.html">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</a>
        
        <div class="dropdown">
            <span style="cursor:pointer; font-weight:bold; color: #3b82f6;">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¸Ø§Ù‡Ø±</span>
            <div class="dropdown-content">
                <div style="margin-bottom:10px; font-size:0.8rem; font-weight:bold;">Ø­Ø§Ù„Øª Ù†Ù…Ø§ÛŒØ´:</div>
                <button onclick="toggleTheme()" style="width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text); cursor:pointer; font-family:inherit;">ğŸŒ“ Ø±ÙˆØ² / Ø´Ø¨</button>
                <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                <div style="margin-bottom:10px; font-size:0.8rem; font-weight:bold;">Ø±Ù†Ú¯ Ø¨Ø±Ù†Ø¯ÛŒÙ†Ú¯:</div>
                <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                    <div class="color-opt" style="background:#ef4444" onclick="changeColor('#ef4444')"></div>
                    <div class="color-opt" style="background:#3b82f6" onclick="changeColor('#3b82f6')"></div>
                    <div class="color-opt" style="background:#10b981" onclick="changeColor('#10b981')"></div>
                    <div class="color-opt" style="background:#8b5cf6" onclick="changeColor('#8b5cf6')"></div>
                </div>
            </div>
        </div>
        
        <a href="#" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</a>
    </div>
</nav>

<div class="container" style="padding-top: 30px;">
    
    <div class="section-title">âš¡ Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡</div>
    <div class="card" style="border-left: 4px solid #3b82f6;">
        <form id="addNodeForm">
            <div class="smart-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                    <input type="text" id="nodeName" class="form-control" placeholder="Ù…Ø«Ù„Ø§: Ø³Ø±ÙˆØ± VIP Ø¢Ù„Ù…Ø§Ù† ğŸ‡©ğŸ‡ª" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ù…ÙˆØªÙˆØ± Ù¾Ù†Ù„</label>
                    <select id="panelType" class="form-control">
                        <option value="marzban">Ù…Ø±Ø²Ø¨Ø§Ù† (Marzban)</option>
                        <option value="pasarguard">Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯ (PasarGuard)</option>
                        <option value="wgdashboard">ÙˆØ§ÛŒØ±Ú¯Ø§Ø±Ø¯ (WGDashboard)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¢Ø¯Ø±Ø³ API Ø³Ø±ÙˆØ±</label>
                    <input type="url" id="apiUrl" class="form-control" placeholder="https://1.2.3.4:8000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÛŒÙˆØ²Ø± Ùˆ Ù¾Ø³ÙˆØ±Ø¯ (ÛŒØ§ ØªÙˆÚ©Ù†)</label>
                    <input type="text" id="apiToken" class="form-control" placeholder="Ù…Ø«Ù„Ø§: admin:password" required>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="isVisible" checked>
                    <span style="font-weight: bold;">Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù„ÛŒÙ†Ú© Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</span>
                </label>
            </div>

            <button type="submit" class="btn-main" id="submitNodeBtn" style="background: #3b82f6; width: 100%; margin-top: 15px;">â• ØªØ³Øª Ø§ØªØµØ§Ù„ Ùˆ Ø«Ø¨Øª Ø³Ø±ÙˆØ±</button>
        </form>
    </div>

    <div class="section-title" style="margin-top: 40px;">ğŸŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ØªØµÙ„</div>
    <div class="card">
        <div id="nodesList" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            <p style="text-align: center; opacity: 0.6;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§...</p>
        </div>
    </div>

</div>

<script src="../assets/js/app.js"></script> 
<script>
    const token = localStorage.getItem("guardino_token");
    if (!token) window.location.href = "login.html";

    function logout() { localStorage.clear(); window.location.href = "login.html"; }

    async function fetchNodes() {
        try {
            const res = await fetch("/api/v1/nodes/list", { headers: { "Authorization": `Bearer ${token}` } });
            const data = await res.json();
            const container = document.getElementById("nodesList");
            container.innerHTML = "";

            if (data.nodes && data.nodes.length > 0) {
                data.nodes.forEach(node => {
                    const isActive = node.status === 'active';
                    const statusColor = isActive ? '#10b981' : '#ef4444';
                    const toggleText = isActive ? 'Ø®Ø§Ù…ÙˆØ´ Ú©Ù†' : 'Ø±ÙˆØ´Ù† Ú©Ù†';
                    
                    container.innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <div style="font-weight: 900; font-size: 1.1rem; color: var(--text);">${node.display_name} <span style="font-size:0.7rem; opacity:0.6;">(ID: ${node.id})</span></div>
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">${node.panel_type.toUpperCase()} | <span style="direction: ltr; display: inline-block;">${node.api_url}</span></div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="background: ${statusColor}20; color: ${statusColor}; padding: 5px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: bold;">${node.status.toUpperCase()}</span>
                                
                                <button onclick="toggleNode(${node.id})" class="btn-main btn-gray" style="padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0;">${toggleText}</button>
                                <button onclick="deleteNode(${node.id})" class="btn-main" style="background: #ef4444; padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                });
            } else { container.innerHTML = "<p style='text-align:center;'>Ù‡ÛŒÚ† Ø³Ø±ÙˆØ±ÛŒ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.</p>"; }
        } catch (e) { document.getElementById("nodesList").innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª."; }
    }

    // Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆØ¯
    document.getElementById('addNodeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitNodeBtn');
        btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· (ØªØ³Øª Ù¾ÛŒÙ†Ú¯)..."; btn.disabled = true;

        const payload = {
            display_name: document.getElementById('nodeName').value,
            panel_type: document.getElementById('panelType').value,
            api_url: document.getElementById('apiUrl').value,
            api_token: document.getElementById('apiToken').value,
            status: "active",
            is_visible_in_sub: document.getElementById('isVisible').checked
        };

        try {
            const res = await fetch("/api/v1/nodes/add", {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                if(typeof showToast === "function") showToast(data.message, "success"); else alert(data.message);
                document.getElementById('addNodeForm').reset(); fetchNodes();
            } else {
                if(typeof showToast === "function") showToast(data.detail, "danger"); else alert(data.detail);
            }
        } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø´Ø¨Ú©Ù‡"); } 
        finally { btn.innerText = "â• ØªØ³Øª Ø§ØªØµØ§Ù„ Ùˆ Ø«Ø¨Øª Ø³Ø±ÙˆØ±"; btn.disabled = false; }
    });

    // Ø­Ø°Ù Ù†ÙˆØ¯
    async function deleteNode(id) {
        if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;
        try {
            const res = await fetch(`/api/v1/nodes/${id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
            if(res.ok) { fetchNodes(); } else { alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±ÙˆÛŒ Ø§ÛŒÙ† Ø³Ø±ÙˆØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯."); }
        } catch(e) { alert("Ø®Ø·Ø§"); }
    }

    // Ø®Ø§Ù…ÙˆØ´/Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ù†ÙˆØ¯
    async function toggleNode(id) {
        try {
            const res = await fetch(`/api/v1/nodes/${id}/toggle`, { method: "PUT", headers: { "Authorization": `Bearer ${token}` } });
            if(res.ok) fetchNodes();
        } catch(e) { alert("Ø®Ø·Ø§"); }
    }

    fetchNodes();
</script>
</body>
</html>
