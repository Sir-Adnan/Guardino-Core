<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† | Ú¯Ø§Ø±Ø¯ÛŒÙ†Ùˆ Ù¾Ø±Ùˆ</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <style>
        .admin-nav { background: #1e293b; border-bottom: 2px solid #3b82f6; }
        .admin-nav a { color: #f8fafc; }
    </style>
</head>
<body class="dark-mode">

<nav class="navbar admin-nav">
    <a href="index.html" class="nav-brand" style="color: #3b82f6;">ğŸ‘‘ GUARDINO CORE</a>
    <div class="nav-menu">
        <a href="index.html">ğŸŒ Ø´Ø¨Ú©Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ (Nodes)</a>
        <a href="resellers.html" style="color: #3b82f6;">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</a>
        <a href="#" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</a>
    </div>
</nav>

<div class="container" style="padding-top: 30px;">
    
    <button class="btn-main btn-auto-pill" onclick="toggleSection('addForm', 'block')" style="background: #8b5cf6;">â• Ø«Ø¨Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯</button>

    <div class="card card-bordered" id="addForm" style="display: none; border-color: #8b5cf6;">
        <h3 class="section-title" style="margin-top: 0;">ğŸ‘¤ Ù…Ø´Ø®ØµØ§Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
        <form id="addResellerForm">
            <div class="grid-create">
                <div class="form-group"><label class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ±ÙˆØ¯</label><input type="text" id="rUsername" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙˆØ±ÙˆØ¯</label><input type="password" id="rPassword" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯ÛŒÚ¯ (ØªÙˆÙ…Ø§Ù†)</label><input type="number" id="rBasePrice" class="form-control" value="1000" required></div>
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø¯Ø³ØªØ±Ø³ÛŒ</label>
                    <select id="rCanSub" class="form-control">
                        <option value="true">Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ø±Ø´Ø¯ (Master)</option>
                        <option value="false">Ø®Ø±Ø¯Ù‡â€ŒÙØ±ÙˆØ´ (Sub)</option>
                    </select>
                </div>
            </div>
            <div class="flex-actions">
                <button type="submit" id="addBtn" class="btn-main btn-w-150" style="background: #8b5cf6;">Ø«Ø¨Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ…</button>
                <button type="button" class="btn-main btn-w-150 btn-gray" onclick="toggleSection('addForm', 'block')">Ø¨Ø³ØªÙ†</button>
            </div>
        </form>
    </div>

    <button class="btn-main btn-auto-pill" onclick="toggleSection('allocForm', 'block')" style="background: #10b981; margin-right: 10px;">ğŸ”— ØªØ®ØµÛŒØµ Ø³Ø±ÙˆØ±</button>

    <div class="card card-bordered" id="allocForm" style="display: none; border-color: #10b981;">
        <h3 class="section-title" style="margin-top: 0;">ğŸ”— ØªØ®ØµÛŒØµ Ø³Ø±ÙˆØ± Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</h3>
        <form id="allocateNodeForm">
            <div class="smart-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ù‡Ø¯Ù</label>
                    <select id="allocResellerId" class="form-control" required>
                        <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆØ±</label>
                    <select id="allocNodeId" class="form-control" required>
                        <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
                    </select>
                </div>
            </div>
            <div class="flex-actions" style="margin-top: 15px;">
                <button type="submit" id="allocBtn" class="btn-main btn-w-150" style="background: #10b981;">ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ</button>
                <button type="button" class="btn-main btn-w-150 btn-gray" onclick="toggleSection('allocForm', 'block')">Ø¨Ø³ØªÙ†</button>
            </div>
        </form>
    </div>

    <h3 class="section-title mt-4">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ø³ÛŒØ³ØªÙ…</h3>
    <div id="resellersContainer">
        <p style="text-align: center; opacity: 0.6;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>

</div>

<script src="../assets/js/app.js"></script>
<script>
    const token = localStorage.getItem("guardino_token");
    if (!token) window.location.href = "login.html";

    function logout() { localStorage.clear(); window.location.href = "login.html"; }

    function toggleSection(id, displayType = 'block') {
        let el = document.getElementById(id);
        if(el) el.style.display = (el.style.display === 'none' || el.style.display === '') ? displayType : 'none';
    }

    // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ ØªØ®ØµÛŒØµ Ø³Ø±ÙˆØ±
    async function loadSelectData() {
        try {
            const resResellers = await fetch("/api/v1/resellers/list", { headers: { "Authorization": `Bearer ${token}` } });
            const dataResellers = await resResellers.json();
            const rSelect = document.getElementById("allocResellerId");
            rSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡...</option>';
            if(dataResellers.resellers) {
                dataResellers.resellers.forEach(r => {
                    rSelect.innerHTML += `<option value="${r.id}">${r.username} (Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${r.balance.toLocaleString()})</option>`;
                });
            }

            const resNodes = await fetch("/api/v1/nodes/list", { headers: { "Authorization": `Bearer ${token}` } });
            const dataNodes = await resNodes.json();
            const nSelect = document.getElementById("allocNodeId");
            nSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÙˆØ±...</option>';
            if(dataNodes.nodes) {
                dataNodes.nodes.forEach(n => {
                    nSelect.innerHTML += `<option value="${n.id}">${n.display_name} (${n.panel_type})</option>`;
                });
            }
        } catch (e) { console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ú©Ø´ÙˆÛŒÛŒ"); }
    }

    // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†
    async function loadResellers() {
        try {
            const res = await fetch("/api/v1/resellers/list", { headers: { "Authorization": `Bearer ${token}` } });
            const data = await res.json();
            const container = document.getElementById("resellersContainer");
            container.innerHTML = "";

            if(data.resellers && data.resellers.length > 0) {
                data.resellers.forEach(r => {
                    const badge_color = r.status === 'active' ? '#10b981' : '#ef4444';
                    const badge_bg = r.status === 'active' ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)';
                    const badge_text = r.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'Ù…Ø³Ø¯ÙˆØ¯';
                    
                    container.innerHTML += `
                    <div class="mz-card" style="border-left: 4px solid #3b82f6;">
                        <div class="mz-col-user flex-1-5">
                            <span class="mz-dot" style="background: ${badge_color}; box-shadow: 0 0 8px ${badge_color};"></span>
                            <span class="mz-name text-xl">${r.username} <span style="font-size: 0.7rem; opacity: 0.6;">(ID: ${r.id})</span></span>
                            <span class="mz-badge" style="color: ${badge_color}; background: ${badge_bg}; margin-right: 10px;">${badge_text}</span>
                        </div>
                        
                        <div class="mz-col-status">
                            <div class="font-black text-xl text-primary text-left" id="bal-${r.id}">${r.balance.toLocaleString()} T</div>
                            <div class="mz-expire">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
                        </div>

                        <div class="mz-col-status">
                            <div class="font-black text-lg text-left">${r.price.toLocaleString()} T</div>
                            <div class="mz-expire">ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡</div>
                        </div>

                        <div class="mz-col-actions">
                            <button onclick="toggleSection('charge-${r.id}', 'flex')" class="mz-btn" style="background:rgba(16,185,129,0.1); color:#10b981;" title="Ø´Ø§Ø±Ú˜ Ù…Ø§Ù„ÛŒ">ğŸ’³</button>
                        </div>

                        <div id="charge-${r.id}" class="form-collapse">
                            <form onsubmit="handleCharge(event, ${r.id})" class="form-row">
                                <div class="form-col-1">
                                    <label class="form-label">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</label>
                                    <select id="ctype-${r.id}" class="form-control" style="border-color:#10b981;">
                                        <option value="add">â• Ø§ÙØ²Ø§ÛŒØ´ Ø´Ø§Ø±Ú˜</option>
                                        <option value="sub">â– Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ</option>
                                    </select>
                                </div>
                                <div class="form-col-1">
                                    <label class="form-label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                                    <input type="number" id="camt-${r.id}" class="form-control" required min="1">
                                </div>
                                <div class="form-col-2">
                                    <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                                    <input type="text" id="cdesc-${r.id}" class="form-control" placeholder="Ø¨Ø§Ø¨Øª...">
                                </div>
                                <button type="submit" id="cbtn-${r.id}" class="btn-main btn-auto btn-green">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>
                            </form>
                        </div>
                    </div>
                    `;
                });
            } else { 
                container.innerHTML = `<div class="card" style="text-align:center;">Ù‡ÛŒÚ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>`; 
            }
        } catch (e) { container.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª</p>"; }
    }

    document.getElementById('addResellerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('addBtn'); btn.disabled = true; btn.innerText = "â³...";
        const payload = {
            username: document.getElementById('rUsername').value,
            password: document.getElementById('rPassword').value,
            daily_subscription_fee: 0,
            base_price_per_gb: parseInt(document.getElementById('rBasePrice').value),
            base_price_master_sub: parseInt(document.getElementById('rBasePrice').value),
            can_create_sub: document.getElementById('rCanSub').value === "true"
        };
        try {
            const res = await fetch("/api/v1/resellers/create", {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }, body: JSON.stringify(payload)
            });
            if (res.ok) { 
                if(typeof showToast === "function") showToast("âœ… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!", "success");
                else alert("âœ… Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!");
                loadResellers(); 
                loadSelectData(); // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ
                document.getElementById('addResellerForm').reset(); 
                toggleSection('addForm'); 
            } else { 
                const d = await res.json(); 
                if(typeof showToast === "function") showToast(d.detail || "Ø®Ø·Ø§", "danger");
                else alert(d.detail || "Ø®Ø·Ø§");
            }
        } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·"); }
        finally { btn.disabled = false; btn.innerText = "Ø«Ø¨Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ…"; }
    });

    document.getElementById('allocateNodeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('allocBtn'); btn.disabled = true; btn.innerText = "â³...";
        const rId = document.getElementById('allocResellerId').value;
        try {
            const res = await fetch(`/api/v1/resellers/${rId}/allocate-node`, {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ node_id: parseInt(document.getElementById('allocNodeId').value) })
            });
            if (res.ok) { 
                if(typeof showToast === "function") showToast("âœ… Ø³Ø±ÙˆØ± ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!", "success");
                else alert("âœ… Ø³Ø±ÙˆØ± ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!");
                document.getElementById('allocateNodeForm').reset(); 
                toggleSection('allocForm'); 
            } else { 
                const d = await res.json(); 
                if(typeof showToast === "function") showToast(d.detail || "Ø®Ø·Ø§", "danger");
                else alert(d.detail || "Ø®Ø·Ø§");
            }
        } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·"); }
        finally { btn.disabled = false; btn.innerText = "ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ"; }
    });

    async function handleCharge(e, id) {
        e.preventDefault();
        const btn = document.getElementById(`cbtn-${id}`); btn.disabled = true; btn.innerText = "â³...";
        const payload = {
            type: document.getElementById(`ctype-${id}`).value,
            amount: parseInt(document.getElementById(`camt-${id}`).value),
            description: document.getElementById(`cdesc-${id}`).value
        };

        try {
            const res = await fetch(`/api/v1/resellers/${id}/charge`, {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                if(typeof showToast === "function") showToast("âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯!", "success");
                else alert("âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯!");
                document.getElementById(`bal-${id}`).innerText = data.new_balance.toLocaleString() + " T";
                document.getElementById(`camt-${id}`).value = "";
                document.getElementById(`cdesc-${id}`).value = "";
                toggleSection(`charge-${id}`);
                loadSelectData(); // Ø¢Ù¾Ø¯ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ
            } else { 
                if(typeof showToast === "function") showToast(data.detail || "Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´", "danger");
                else alert(data.detail || "Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´");
            }
        } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·"); }
        finally { btn.disabled = false; btn.innerText = "Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´"; }
    }

    // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    loadResellers();
    loadSelectData();
</script>
</body>
</html>
