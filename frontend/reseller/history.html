<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุงุฑุฎฺู ูุงู | ฺฏุงุฑุฏูู ูพุฑู</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="nav-brand">GUARDINO</a>
    <div class="hamburger" onclick="toggleMenu()">โฐ</div>
    <div class="nav-menu" id="navMenu">
        <a href="index.html">๐ ุฏุงุดุจูุฑุฏ</a>
        <a href="users.html">๐ฅ ูุฏุฑุช ฺฉุงุฑุจุฑุงู</a>
        <a href="history.html" style="color: var(--primary);">๐ ุชุงุฑุฎฺู ูุงู</a>
        <a href="#" onclick="logout()">๐ช ุฎุฑูุฌ</a>
    </div>
</nav>

<div class="container" style="padding-top: 20px;">
    
    <div class="section-title">๐ ฺฏุฑุฏุด ุญุณุงุจ ู ุชุฑุงฺฉูุดโูุง</div>
    
    <div class="card">
        <table style="width: 100%; border-collapse: collapse; text-align: right; min-width: 500px;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border); color: var(--text); opacity: 0.8;">
                    <th style="padding: 12px 10px;">ุดุฑุญ ุชุฑุงฺฉูุด</th>
                    <th>ููุน ุนููุงุช</th>
                    <th>ูุจูุบ (ุชููุงู)</th>
                    <th>ุชุงุฑุฎ ู ุฒูุงู</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                <tr><td colspan="4" style="text-align:center; padding: 20px; opacity: 0.6;">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช...</td></tr>
            </tbody>
        </table>
    </div>

</div>

<script src="../assets/js/app.js"></script>
<script>
    const token = localStorage.getItem("guardino_token");
    if (!token) window.location.href = "login.html";

    // ููู ููุงูุฏู ุงุฑุดุฏ
    const userRole = localStorage.getItem("reseller_role");
    if (userRole === "master") {
        const navMenu = document.getElementById("navMenu");
        const subResellerLink = document.createElement("a");
        subResellerLink.href = "sub-resellers.html"; 
        subResellerLink.innerHTML = "๐ข ุฒุฑูุฌููุนูโูุง ูู";
        navMenu.insertBefore(subResellerLink, navMenu.lastElementChild);
    }

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    // ููุฏ ฺฉุฑุฏู ุชุงุฑุฎฺู ุงุฒ API
    async function loadHistory() {
        try {
            const response = await fetch("http://localhost:8000/api/v1/resellers/history", {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await response.json();
            const tbody = document.getElementById("historyTableBody");
            tbody.innerHTML = "";

            if (data.history && data.history.length > 0) {
                data.history.forEach(log => {
                    // ุชุนู ุฑูฺฏ ู ุนูุงูุช ูุจูุบ (ูุซุจุช: ุณุจุฒุ ููู: ูุฑูุฒ)
                    let amountColor = log.amount < 0 ? "#ef4444" : "#10b981";
                    let amountSign = log.amount > 0 ? "+" : "";
                    
                    // ุชุฑุฌูู ููุน ุนููุงุช
                    let typeLabel = "ูุงูุดุฎุต";
                    let typeColor = "#6b7280";
                    if (log.type === "buy_vpn") { typeLabel = "ุฎุฑุฏ ุงุดุชุฑุงฺฉ"; typeColor = "#3b82f6"; }
                    else if (log.type === "wallet_charge") { typeLabel = "ุดุงุฑฺ ฺฉู ูพูู"; typeColor = "#10b981"; }
                    else if (log.type === "daily_fee") { typeLabel = "ุขุจูููุงู ูพูู"; typeColor = "#f59e0b"; }
                    else if (log.type === "refund") { typeLabel = "ุงุณุชุฑุฏุงุฏ ูุฌู"; typeColor = "#8b5cf6"; }

                    // ุชุจุฏู ุชุงุฑุฎ ููุงุฏ ุจู ุดูุณ
                    let dateObj = new Date(log.date);
                    let formattedDate = dateObj.toLocaleDateString('fa-IR') + " - " + dateObj.toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 15px 10px; color: var(--text); font-size: 0.9rem;">${log.description}</td>
                            <td><span style="background: ${typeColor}20; color: ${typeColor}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">${typeLabel}</span></td>
                            <td style="color: ${amountColor}; font-weight: bold; font-family: monospace; font-size: 1.1rem; direction: ltr; text-align: right;">
                                ${amountSign}${log.amount.toLocaleString()}
                            </td>
                            <td style="font-size: 0.85rem; opacity: 0.8; direction: ltr; text-align: right;">${formattedDate}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">ูฺ ุชุฑุงฺฉูุด ุซุจุช ูุดุฏู ุงุณุช.</td></tr>`;
            }
        } catch (e) {
            document.getElementById("historyTableBody").innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px; color: red;">ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช.</td></tr>`;
        }
    }

    loadHistory();
</script>
</body>
</html>
