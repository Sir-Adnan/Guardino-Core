<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฏุฑุช ฺฉุงุฑุจุฑุงู | ฺฏุงุฑุฏูู ูพุฑู</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="nav-brand">GUARDINO</a>
    <div class="nav-menu">
        <a href="index.html">๐ ุฏุงุดุจูุฑุฏ</a>
        <a href="users.html" style="color: var(--primary);">๐ฅ ูุฏุฑุช ฺฉุงุฑุจุฑุงู</a>
    </div>
</nav>

<div class="container" style="padding-top: 20px;">
    
    <div class="card">
        <div class="section-title">โจ ุณุงุฎุช ุงุดุชุฑุงฺฉ ุฌุฏุฏ (Smart Routing)</div>
        <form id="createUserForm">
            <div class="smart-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">ูุงู ฺฉุงุฑุจุฑ (ุงูฺฏูุณ)</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="username" class="form-control" required>
                        <button type="button" class="btn-main btn-gray" onclick="genU()" style="padding: 0 10px;">๐ฒ</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ุญุฌู (ฺฏฺฏุงุจุงุช - 0 ูุงูุญุฏูุฏ)</label>
                    <input type="number" id="dataLimit" class="form-control" value="50" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ุฒูุงู (ุฑูุฒ - 0 ูุงูุญุฏูุฏ)</label>
                    <input type="number" id="expireDays" class="form-control" value="30" required>
                </div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">ุงูุชุฎุงุจ ุณุฑูุฑูุง (ุชุฑฺฉุจ ููฺฉ ุณุงุจ)</label>
                <div id="nodesContainer" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                    <span style="opacity: 0.6; font-size: 0.85rem;">ุฏุฑ ุญุงู ุฏุฑุงูุช ูุณุช ุณุฑูุฑูุง...</span>
                </div>
            </div>

            <button type="submit" class="btn-main" id="submitBtn" style="margin-top: 15px; width: 100%;">๐ ุงุฌุงุฏ ู ุฏุฑุงูุช ููฺฉ ุณุงุจ ูุณุชุฑ</button>
        </form>
    </div>

    <div id="resultCard" class="card" style="display: none; border: 2px solid #10b981;">
        <div class="section-title" style="color: #10b981;">โ ฺฉุงุฑุจุฑ ุจุง ููููุช ุณุงุฎุชู ุดุฏ!</div>
        <p id="costDisplay" style="font-weight: bold;"></p>
        <div class="input-flex" style="display: flex; gap: 10px; margin-top: 10px;">
            <input type="text" id="masterSubLink" class="form-control" readonly style="direction: ltr; text-align: left;">
            <button type="button" class="btn-main" onclick="copyMasterLink()">๐ ฺฉูพ ููฺฉ</button>
        </div>
    </div>

</div>

<script src="../assets/js/app.js"></script>
<script>
    const token = localStorage.getItem("guardino_token");
    if (!token) window.location.href = "login.html";

    // 1. ุฏุฑุงูุช ูุณุช ุณุฑูุฑูุง ูุฌุงุฒ ุจุฑุง ุงู ููุงูุฏู ุงุฒ ูพุงุชูู
    async function loadAvailableNodes() {
        try {
            const response = await fetch("http://localhost:8000/api/v1/nodes/list", {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await response.json();
            
            const container = document.getElementById("nodesContainer");
            container.innerHTML = ""; // ูพุงฺฉ ฺฉุฑุฏู ูุชู "ุฏุฑ ุญุงู ุฏุฑุงูุช..."

            if(data.nodes && data.nodes.length > 0) {
                data.nodes.forEach(node => {
                    // ุณุงุฎุช ฺฺฉโุจุงฺฉุณ ุจุฑุง ูุฑ ุณุฑูุฑ
                    container.innerHTML += `
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; background: var(--card); padding: 5px 10px; border-radius: 6px; border: 1px solid var(--border);">
                            <input type="checkbox" name="selectedNodes" value="${node.id}" checked>
                            <span style="font-size: 0.85rem; font-weight: bold;">${node.display_name}</span>
                            <span style="font-size: 0.7rem; opacity: 0.7;">(${node.panel_type})</span>
                        </label>
                    `;
                });
            } else {
                container.innerHTML = "<span style='color: red;'>ุดูุง ุจู ูฺ ุณุฑูุฑ ุฏุณุชุฑุณ ูุฏุงุฑุฏ!</span>";
            }
        } catch (e) {
            document.getElementById("nodesContainer").innerHTML = "ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ ูุฑฺฉุฒ.";
        }
    }

    // 2. ููุฏู ฺฉุฑุฏู ูุฑู ุณุงุฎุช ฺฉุงุฑุจุฑ (ุงุฑุณุงู ุจู ููุชูุฑ ูพุงุชูู)
    document.getElementById('createUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // ุฌูุนโุขูุฑ ุขุฏ ุณุฑูุฑูุง ฺฉู ุชฺฉ ุฎูุฑุฏูโุงูุฏ
        const checkboxes = document.querySelectorAll('input[name="selectedNodes"]:checked');
        const nodeIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (nodeIds.length === 0) {
            showToast("ูุทูุง ุญุฏุงูู ฺฉ ุณุฑูุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ!", "danger");
            return;
        }

        const payload = {
            username: document.getElementById('username').value,
            data_limit_gb: parseFloat(document.getElementById('dataLimit').value),
            expire_days: parseInt(document.getElementById('expireDays').value),
            node_ids: nodeIds
        };

        const btn = document.getElementById('submitBtn');
        btn.innerText = "โณ ุฏุฑ ุญุงู ุณุงุฎุช ููุฒูุงู (Syncing)...";
        btn.disabled = true;

        try {
            const response = await fetch("http://localhost:8000/api/v1/users/create", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                showToast("ฺฉุงุฑุจุฑ ุจุง ููููุช ุฏุฑ ุดุจฺฉูโูุง ุณุงุฎุชู ุดุฏ!", "success");
                
                // ููุงุด ฺฉุงุฑุช ููฺฉ ุณุงุจ
                document.getElementById('resultCard').style.display = 'block';
                document.getElementById('masterSubLink').value = data.sub_link;
                document.getElementById('costDisplay').innerText = `ูุจูุบ ฺฉุณุฑ ุดุฏู ุงุฒ ฺฉู ูพูู: ${data.total_cost.toLocaleString()} ุชููุงู`;
                
                // ุขูพุฏุช ููุฌูุฏ ุฐุฎุฑู ุดุฏู
                let currentBal = parseInt(localStorage.getItem("reseller_balance"));
                localStorage.setItem("reseller_balance", currentBal - data.total_cost);

            } else {
                showToast(data.detail || "ุฎุทุง ุฏุฑ ุณุงุฎุช ฺฉุงุฑุจุฑ", "danger");
            }
        } catch (err) {
            showToast("ุฎุทุง ุฏุฑ ุจุฑูุฑุงุฑ ุงุฑุชุจุงุท ุจุง ูุณุชู ูุฑฺฉุฒ ฺฏุงุฑุฏูู", "danger");
        } finally {
            btn.innerText = "๐ ุงุฌุงุฏ ู ุฏุฑุงูุช ููฺฉ ุณุงุจ ูุณุชุฑ";
            btn.disabled = false;
        }
    });

    // ุชุงุจุน ฺฉูฺฉ ุจุฑุง ฺฉูพ ฺฉุฑุฏู ููฺฉ ุณุงุจ
    function copyMasterLink() {
        const link = document.getElementById('masterSubLink').value;
        navigator.clipboard.writeText(link).then(() => {
            showToast("โ ููฺฉ ุณุงุจ ฺฏุงุฑุฏูู ฺฉูพ ุดุฏ!");
        });
    }

    // ุชููุฏ ูุงู ฺฉุงุฑุจุฑ ุฑูุฏูู
    function genU() {
        document.getElementById('username').value = "user_" + Math.random().toString(36).substr(2, 6);
    }

    // ุงุฌุฑุง ุชุงุจุน ููุฏ ุณุฑูุฑูุง ููฺฏุงู ุจุงุฒ ุดุฏู ุตูุญู
    loadAvailableNodes();
</script>
</body>
</html>
